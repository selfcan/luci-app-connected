name: Build OpenWrt IPK

on:
  push:
    branches:
      - master
  pull_request:
  workflow_dispatch:

env:
  PKG_NAME: luci-app-connected
  PKG_VERSION: "1.0.0"
  PKG_RELEASE: "1"

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Build IPK
      run: |
        # Create temp directories
        mkdir -p build/{control,data}

        # Copy files to data directory
        mkdir -p build/data/usr/lib/lua/luci/controller
        mkdir -p build/data/usr/lib/lua/luci/view/connected
        cp usr/lib/lua/luci/controller/connected.lua build/data/usr/lib/lua/luci/controller/
        cp usr/lib/lua/luci/view/connected/index.htm build/data/usr/lib/lua/luci/view/connected/

        # Create control file
        cat > build/control/control << EOF
        Package: ${{ env.PKG_NAME }}
        Version: ${{ env.PKG_VERSION }}-${{ env.PKG_RELEASE }}
        Depends: luci-base
        Section: luci
        Architecture: all
        Installed-Size: $(du -sb build/data | cut -f1)
        Description: A LuCI application to view connected devices on OpenWrt.
        EOF

        # Create debian-binary
        echo "2.0" > build/debian-binary

        # Create tarballs
        cd build/control && tar -czf ../control.tar.gz .
        cd ../data && tar -czf ../data.tar.gz .
        cd ..

        # Create IPK
        ar r ${{ env.PKG_NAME }}_${{ env.PKG_VERSION }}-${{ env.PKG_RELEASE }}_all.ipk debian-binary control.tar.gz data.tar.gz

    - name: Upload IPK
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.PKG_NAME }}
        path: build/${{ env.PKG_NAME }}_*.ipk
