name: Build OpenWrt IPK

on:
  push:
    branches:
      - master
  pull_request:
  workflow_dispatch:

env:
  PKG_NAME: luci-app-connected
  PKG_VERSION: "1.0.0"
  PKG_RELEASE: "1"

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install opkg-utils
      run: |
        git clone --depth 1 https://git.openwrt.org/project/opkg-lede.git /tmp/opkg-lede

    - name: Build IPK
      run: |
        set -e

        # Create package directory structure for opkg-build
        mkdir -p pkg/CONTROL
        mkdir -p pkg/usr/lib/lua/luci/controller
        mkdir -p pkg/usr/lib/lua/luci/view/connected

        # Copy files
        cp usr/lib/lua/luci/controller/connected.lua pkg/usr/lib/lua/luci/controller/
        cp usr/lib/lua/luci/view/connected/index.htm pkg/usr/lib/lua/luci/view/connected/

        # Create control file
        cat > pkg/CONTROL/control << 'CTRLEOF'
        Package: ${{ env.PKG_NAME }}
        Version: ${{ env.PKG_VERSION }}-${{ env.PKG_RELEASE }}
        Depends: luci-base
        Section: luci
        Architecture: all
        Description: A LuCI application to view connected devices on OpenWrt.
        CTRLEOF

        # Remove leading whitespace from control file
        sed -i 's/^        //' pkg/CONTROL/control

        # Build using opkg-build
        mkdir -p build
        /tmp/opkg-lede/opkg-build -o root -g root pkg build/

        # Show result
        ls -la build/*.ipk

    - name: Upload IPK
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.PKG_NAME }}
        path: build/${{ env.PKG_NAME }}_*.ipk
