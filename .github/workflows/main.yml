name: Build OpenWrt IPK

on:
  push:
    branches:
      - master
  pull_request:
  workflow_dispatch:

env:
  PKG_NAME: luci-app-connected
  PKG_VERSION: "1.0.0"
  PKG_RELEASE: "1"

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Build IPK
      run: |
        set -ex
        PKG_FILE="${{ env.PKG_NAME }}_${{ env.PKG_VERSION }}-${{ env.PKG_RELEASE }}_all.ipk"

        # Create data directory structure
        mkdir -p data/usr/lib/lua/luci/controller
        mkdir -p data/usr/lib/lua/luci/view/connected

        # Copy files
        cp usr/lib/lua/luci/controller/connected.lua data/usr/lib/lua/luci/controller/
        cp usr/lib/lua/luci/view/connected/index.htm data/usr/lib/lua/luci/view/connected/

        # Create control directory and file
        mkdir -p control
        echo "Package: ${{ env.PKG_NAME }}" > control/control
        echo "Version: ${{ env.PKG_VERSION }}-${{ env.PKG_RELEASE }}" >> control/control
        echo "Depends: luci-base" >> control/control
        echo "Section: luci" >> control/control
        echo "Architecture: all" >> control/control
        echo "Maintainer: Bruno <bruno@example.com>" >> control/control
        echo "Description: A LuCI application to view connected devices on OpenWrt." >> control/control

        # Create debian-binary
        echo "2.0" > debian-binary

        # Create tarballs (fakeroot for proper ownership)
        fakeroot tar -czvf control.tar.gz -C control .
        fakeroot tar -czvf data.tar.gz -C data .

        # Use GNU ar but with minimal/BSD-compatible format
        # The key is the order: debian-binary MUST be first
        rm -f "$PKG_FILE"
        ar rcsD "$PKG_FILE" debian-binary control.tar.gz data.tar.gz

        # Show what we built
        mkdir -p build
        mv "$PKG_FILE" build/
        echo "=== Built package ==="
        ls -la build/"$PKG_FILE"
        echo "=== AR contents ==="
        ar -tv build/"$PKG_FILE"
        echo "=== Hex dump of first 200 bytes ==="
        xxd build/"$PKG_FILE" | head -15

    - name: Upload IPK
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.PKG_NAME }}
        path: build/${{ env.PKG_NAME }}_*.ipk
