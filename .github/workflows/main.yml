name: Build IPK manually

on:
  push:
    branches: [ master ]
    tags: [ 'v*' ]
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Build .ipk
        run: |
          mkdir -p build_output
          echo "2.0" > debian-binary
          tar czf control.tar.gz -C . DEBIAN
          tar czf data.tar.gz -C . usr
          ar r build_output/luci-app-connected.ipk debian-binary control.tar.gz data.tar.gz

      - name: Upload IPK artifact
        uses: actions/upload-artifact@v4
        with:
          name: ipk-packages
          path: build_output/*.ipk

      - name: Publish IPK to GitHub Packages
        run: |
          PACKAGE_NAME="luci-app-connected"
          VERSION="latest"
          FILE_PATH="build_output/luci-app-connected.ipk"

          # Delete existing 'latest' version if it exists
          VERSIONS=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" "https://api.github.com/repos/${{ github.repository }}/packages/generic/$PACKAGE_NAME/versions")
          if echo "$VERSIONS" | jq -e 'type == "array"' > /dev/null 2>&1; then
            VERSION_ID=$(echo "$VERSIONS" | jq -r '.[] | select(.name == "'$VERSION'") | .id')
          DATA=$(base64 -w 0 "$FILE_PATH")
          curl -X POST \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d "{\"version\": \"$VERSION\", \"files\": [{\"name\": \"luci-app-connected.ipk\", \"content_type\": \"application/octet-stream\", \"data\": \"$DATA\"}]}" \
            "https://api.github.com/repos/${{ github.repository }}/packages/generic/$PACKAGE_NAME/versions"
