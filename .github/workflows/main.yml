name: Build OpenWrt IPK

on:
  push:
    branches:
      - master
  pull_request:
  workflow_dispatch:

env:
  PKG_NAME: luci-app-connected
  PKG_VERSION: "1.0.0"
  PKG_RELEASE: "1"

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Build IPK
      run: |
        # Create temp directories
        mkdir -p build/{control,data}

        # Copy files to data directory
        mkdir -p build/data/usr/lib/lua/luci/controller
        mkdir -p build/data/usr/lib/lua/luci/view/connected
        cp usr/lib/lua/luci/controller/connected.lua build/data/usr/lib/lua/luci/controller/
        cp usr/lib/lua/luci/view/connected/index.htm build/data/usr/lib/lua/luci/view/connected/

        # Create control file
        echo "Package: ${{ env.PKG_NAME }}" > build/control/control
        echo "Version: ${{ env.PKG_VERSION }}-${{ env.PKG_RELEASE }}" >> build/control/control
        echo "Depends: luci-base" >> build/control/control
        echo "Section: luci" >> build/control/control
        echo "Architecture: all" >> build/control/control
        echo "Description: A LuCI application to view connected devices on OpenWrt." >> build/control/control

        # Create debian-binary
        echo "2.0" > build/debian-binary

        # Create tarballs
        tar -czf build/control.tar.gz -C build/control .
        tar -czf build/data.tar.gz -C build/data .

        # Create IPK (must be in build dir for ar to work correctly)
        cd build
        ar r ${{ env.PKG_NAME }}_${{ env.PKG_VERSION }}-${{ env.PKG_RELEASE }}_all.ipk debian-binary control.tar.gz data.tar.gz
        ls -la *.ipk

    - name: Upload IPK
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.PKG_NAME }}
        path: build/${{ env.PKG_NAME }}_*.ipk
