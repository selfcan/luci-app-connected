name: Build IPK manually

on:
  push:
    branches: [ master ]
    tags: [ 'v*' ]
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Build .ipk package manually
        run: |
          mkdir -p build_output
          echo "2.0" > debian-binary
          tar czf control.tar.gz -C . DEBIAN
          tar czf data.tar.gz -C . usr
          ar r build_output/luci-app-connected.ipk debian-binary control.tar.gz data.tar.gz

      - name: Upload IPK artifact
        uses: actions/upload-artifact@v4
        with:
          name: ipk-packages
          path: build_output/*.ipk

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Publish IPK to GitHub Packages
        run: |
          PACKAGE_NAME="luci-app-connected"
          VERSION="latest"
          FILE_PATH="build_output/luci-app-connected.ipk"

          # Delete existing 'latest' version if it exists
          VERSIONS=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" "https://api.github.com/repos/${{ github.repository }}/packages/generic/$PACKAGE_NAME/versions")
          VERSION_ID=$(echo "$VERSIONS" | jq -r '.[] | select(.name == "'$VERSION'") | .id')
          if [ -n "$VERSION_ID" ]; then
            curl -X DELETE \
              -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
              "https://api.github.com/repos/${{ github.repository }}/packages/generic/$PACKAGE_NAME/versions/$VERSION_ID"
          fi

          # Upload new version
          curl -X PUT \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "Content-Type: application/octet-stream" \
            --data-binary @"$FILE_PATH" \
            "https://uploads.github.com/repos/${{ github.repository }}/packages/generic/$PACKAGE_NAME/$VERSION/luci-app-connected.ipk"
